concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
name: Nightly
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
permissions:
  contents: read
  id-token: write

jobs:
  ui:
    runs-on: ubuntu-latest
    container: node:22-bullseye
    defaults: { run: { working-directory: ui } }
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: 22
      - uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
          run_install: false
          cache: true
          cache-dependency-path: ui/pnpm-lock.yaml
      - uses: actions/cache@v4
        with:
          path: ui/node_modules/.vite
          key: ${{ runner.os }}-vite-${{ hashFiles('ui/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-vite-
      - run: pnpm install
      - run: pnpm --if-present lint
      - run: pnpm --if-present typecheck
      - run: pnpm --if-present build
      - run: pnpm --if-present test:ci
        env: { CI: "true" }
      - name: Verify coverage files
        run: test -f ui/coverage/lcov.info && head -n 20 ui/coverage/lcov.info
      # - name: Upload Codecov (UI)
      #   uses: codecov/codecov-action@v5
      #   with:
      #     files: ui/coverage/lcov.info
      #     flags: ui
      #     fail_ci_if_error: true
      #     verbose: true
  server:
    runs-on: ubuntu-latest
    container: node:22-bullseye
    defaults: { run: { working-directory: server } }
    steps:
      - uses: actions/checkout@v5
      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-server-npm-${{ hashFiles('server/package-lock.json') }}
          restore-keys: ${{ runner.os }}-server-npm-
      - run: npm install
      - run: npm run lint --if-present
      - run: npm run build --if-present
      - run: npm run test:ci --if-present
        env: { CI: "true" }
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v5
      #   with:
      #     files: server/coverage/lcov.info
      #     flags: server
      #     fail_ci_if_error: true
  python:
    runs-on: ubuntu-latest
    env:
      PYTHONHASHSEED: "0"
      # GPU runners must also export CUBLAS_WORKSPACE_CONFIG=:4096:8
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-dev.txt', 'src/gateway/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest pytest-cov pytest-asyncio
      - name: Run tests
        run: pytest -m "not slow" --cov=src --cov-report=xml --cov-report=term-missing --cov-fail-under=100
      - name: Verify coverage files
        run: test -f coverage.xml && head -n 20 coverage.xml
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v5
      #   with:
      #     files: coverage.xml
      #     flags: python
      #     fail_ci_if_error: true
